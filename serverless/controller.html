<html>
<body>
<div>
<table>
<thead><th>Device IP</th><th>Volume</th></thead>
<tbody id="table">
</tbody>
</table>
</div>
<button id="button-up">+</button>
<button id="button-down">-</button>
<div><button id="pause-resume">Pause</button></div>
<div><button id="shutdown">Shutdown</button></div>
<div id="say"></div>
<script>
const device = "192.168.0.";
const port = 9966;

function say(what) {
    document.getElementById("say").innerHTML = what;
}

function showVolume(v, i) {
    if (!document.getElementById("vol" + i)) {
        const tdIp = document.createElement("td");
        tdIp.innerHTML = device + i;

        const tdVol = document.createElement("td");
        tdVol.setAttribute("id", "vol" + i);

        const tr = document.createElement("tr");
        tr.appendChild(tdIp);
        tr.appendChild(tdVol);

        document.getElementById("table").appendChild(tr);
    }
    document.getElementById("vol" + i).innerHTML = v;
}

class RemoteUnit {
    volume = 0;
    id = 0;
    url = "";

    constructor(i) {
        this.id = i;
        const host = device + i;
        say("trying " + host);
        this.url = "http://" + host + ":" + port;
    }

    getVolume(callback) {
        const req = new XMLHttpRequest();
        req.responseType = "json";
        req.open("GET", this.url, true);
        const self = this;
        req.onload  = function() {
            self.volume = req.response.volume;
            callback(self.volume, self.id);
        };
        req.send();
    }

    applyVolume(vol, callback) {
        const req = new XMLHttpRequest();
        req.responseType = "json";
        req.open("PUT", this.url, true);
        req.setRequestHeader("Content-Type", "application/json; charset=utf-8");
        const self = this;
        req.onload  = function() {
            self.volume = req.response.volume;
            callback(self.volume, self.id);
        };
        req.send(JSON.stringify({volume: vol}));
    }

    moveVolume(delta, callback) {
        this.applyVolume(this.volume + delta, callback);
    }

    sendCommand(cmd) {
        const req = new XMLHttpRequest();
        req.responseType = "json";
        req.open("POST", this.url + "/" + cmd, true);
        req.send();
    }
}

class Units {
    units = []
    playing = true;

    add(u) {
        this.units.push(u);
    }

    applyVolume(v, cb) { this.units.map(u => u.applyVolume(v, cb)); }
    moveVolume(v, cb) { this.units.map(u => u.moveVolume(v, cb)); }
    sendCommand(cmd) { this.units.map(u => u.sendCommand(cmd)); }
    pauseResume() {
        this.units.map(u => u.sendCommand(this.playing ? "pause" : "resume"));
        this.playing = !this.playing;
        document.getElementById("pause-resume").innerHTML = this.playing ? "Pause" : "Resume";
    }
}

let units = new Units();

let i = 1;
const searchProc = setInterval(() => {
    const u = new RemoteUnit(i);
    try {
        u.getVolume((v, i) => {
            units.add(u);
            showVolume(v, i);
        });
    } catch (e) {
        say(e.message)
    }
    if (i === 64) {
        clearInterval(searchProc);
        units.applyVolume(70, showVolume);
        say("");
    }
    ++i;
}, 250);

document.getElementById("button-up").setAttribute("onclick", "units.moveVolume(1, showVolume);");
document.getElementById("button-down").setAttribute("onclick", "units.moveVolume(-1, showVolume);");
document.getElementById("pause-resume").setAttribute("onclick", "units.pauseResume();");
document.getElementById("shutdown").setAttribute("onclick", "units.sendCommand('shutdown');");




</script>
</body>
<html>
