<html>
<head>
<title>Randomatones</title>
<style>
body {
    font-family: Arial;
}
h4 {
    margin-bottom: 2px;
    font-size: 110%;
}
th {
    text-align: left;
}
#say {
    margin-top: 4px;
    font-size: 80%;
}
</style>
</head>
<body>
<button id="search">Search</button>
<input type="text" id="subnet" value="192.168.0."/> expecting <input id="expected" type="number" value="3" size="3"/>
<h4>Devices</h4>
<div>
<table>
<thead><th>IP</th><th>Volume</th></thead>
<tbody id="table">
</tbody>
</table>
</div>
<h4>Volume</h4>
<button id="volume-up">+</button>
<button id="volume-down">-</button>
<button id="volume-max">Max</button>
<button id="volume-min">Min</button>
<h4>Control</h4>
<div><button id="pause-resume">Pause</button></div>
<div>
<button id="shutdown">Shutdown</button>
<button id="update-restart">Update and Restart</button>
</div>
<div id="say"></div>
<script>
const port = 9966;
function subnet() {
    return document.getElementById("subnet").getAttribute("value");
}

function say(what) {
    document.getElementById("say").innerHTML = what;
}

function showVolume(v, i) {
    if (!document.getElementById("vol" + i)) {
        const tdIp = document.createElement("td");
        tdIp.innerHTML = subnet() + i;

        const tdVol = document.createElement("td");
        tdVol.setAttribute("id", "vol" + i);

        const tr = document.createElement("tr");
        tr.appendChild(tdIp);
        tr.appendChild(tdVol);

        document.getElementById("table").appendChild(tr);
    }
    document.getElementById("vol" + i).innerHTML = v;
}

class RemoteUnit {
    volume = 0;
    id = 0;
    url = "";

    constructor(i) {
        this.id = i;
        const host = subnet() + i;
        say("trying " + host);
        this.url = "http://" + host + ":" + port;
    }

    getVolume(callback) {
        const req = new XMLHttpRequest();
        req.responseType = "json";
        req.open("GET", this.url, true);
        const self = this;
        req.onload  = function() {
            self.volume = req.response.volume;
            callback(self.volume, self.id);
        };
        req.send();
    }

    applyVolume(vol, callback) {
        const req = new XMLHttpRequest();
        req.responseType = "json";
        req.open("PUT", this.url, true);
        req.setRequestHeader("Content-Type", "application/json; charset=utf-8");
        const self = this;
        req.onload  = function() {
            self.volume = req.response.volume;
            callback(self.volume, self.id);
        };
        req.send(JSON.stringify({volume: vol}));
    }

    moveVolume(delta, callback) {
        this.applyVolume(this.volume + delta, callback);
    }

    postCommand(cmd) {
        const req = new XMLHttpRequest();
        req.responseType = "json";
        req.open("POST", this.url + "/" + cmd, true);
        req.send();
    }
}

class Units {
    units = []
    playing = true;

    add(u) {
        this.units.push(u);
    }

    size() {
        return this.units.length;
    }

    applyVolume(v, cb) { this.units.map(u => u.applyVolume(v, cb)); }
    moveVolume(v, cb) { this.units.map(u => u.moveVolume(v, cb)); }
    postCommand(cmd) { this.units.map(u => u.postCommand(cmd)); }
    pauseResume() {
        this.units.map(u => u.postCommand(this.playing ? "pause" : "resume"));
        this.playing = !this.playing;
        document.getElementById("pause-resume").innerHTML = this.playing ? "Pause" : "Resume";
    }
}

let units = new Units();
const expected = 1 * document.getElementById("expected").value;

function search() {
    let i = 1;
    const searchProc = setInterval(() => {
        const u = new RemoteUnit(i);
        try {
            u.getVolume((v, i) => {
                units.add(u);
                showVolume(v, i);
            });
        } catch (e) {
            say(e.message)
        }
        if (i === 64 || expected === units.size()) {
            clearInterval(searchProc);
            units.applyVolume(70, showVolume);
            say("Found " + units.size() + " unit(s)");
        }
        ++i;
    }, 250);
}

document.getElementById("search").setAttribute("onclick", "search();");
document.getElementById("volume-up").setAttribute("onclick", "units.moveVolume(1, showVolume);");
document.getElementById("volume-down").setAttribute("onclick", "units.moveVolume(-1, showVolume);");
document.getElementById("volume-max").setAttribute("onclick", "units.applyVolume(100, showVolume);");
document.getElementById("volume-min").setAttribute("onclick", "units.applyVolume(50, showVolume);");
document.getElementById("pause-resume").setAttribute("onclick", "units.pauseResume();");
document.getElementById("shutdown").setAttribute("onclick", "units.postCommand('shutdown');");
document.getElementById("update-restart").setAttribute("onclick", "units.postCommand('updateAndRestart');");


</script>
</body>
<html>
