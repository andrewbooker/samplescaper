<html>
    <head>
        <style>
            body, button, th, .label, td {
                font-size: 200%;
            }
            .label {
                text-align: right;
            }
            td {
                text-align: center;
            }
            button {
                font-size: 140%;
                border-radius: 20px;
                padding: 20px 10px 20px 10px;
                margin: 5px;
                min-width: 80px;
            }
            .indicator {
                height: 30px;
            }
            .controls {
                display: flex;
                flex-direction: row;
            }
            .buttons {
                max-width: 50%;
                display: flex;
                flex-direction: column;
                align-items: center;
            }
            .orientation, volume {
                display: flex;
                flex-direction: row;
            }
            .blue {
                color: blue;
            }
            .amber {
                color: orange
            }
            .pink {
                color: pink
            }
        </style>
    </head>
    <body>
        <div class="controls">
            <table cellspacing="0" cellpadding="0">
                <tbody id="tbody"></tbody>
            </table>
            <div class="buttons">
                <div><button id="button-play">start</button></div>
                <div class="volume">
                    <button id="button-volDown"> - </button>
                    <button id="button-volUp"> + </button>
                </div>
                <div class="volume">
                    <button id="button-volMin">Min</button>
                    <button id="button-volMax">Max</button>
                </div>
                <div><img id="img0"/><div>
                <div><button id="button-shutdown">Shutdown</button></div>
            </div>
        </div>
        <script>
            const masterIp = 13;
            const ips = [masterIp, 12, 14];
            const urlBase = "http://192.168.1.";
            const tbody = document.getElementById("tbody");

            (function setupIndicators() {
                ["state", "speedR", "speedL", "direction", "volume"].forEach(s => {
                    const row = document.createElement("tr");
                    const label = document.createElement("td");
                    label.innerHTML = s;
                    label.className = "label";
                    row.appendChild(label);
                    ["blue", "amber", "pink"].forEach((c, i) => {
                        const indicator = document.createElement("td");
                        indicator.setAttribute("id", "indicator-" + s + i);
                        indicator.className = "indicator " + c;
                        row.appendChild(indicator);
                    });

                    tbody.appendChild(row);
                });
            })();

            function motorButton(b, i, c) {
                const button = document.createElement("button");
                button.setAttribute("id", "button-" + b + i);
                switch (b) {
                    case "toggleForwardReverse":
                        button.innerHTML = "reverse";
                        break;
                    case "increase":
                        button.innerHTML = "+";
                        break;
                    case "decrease":
                        button.innerHTML = "-";
                        break;
                    default:
                        button.innerHTML = b;
                }
                button.className = c;
                return button;
            }

            (function setUpMotorControls() {
                ["random", "ahead", ["decrease", "increase"], ["left", "right"], "stop", "toggleForwardReverse"].forEach(b => {
                    const row = document.createElement("tr");
                    const empty = document.createElement("td");
                    row.appendChild(empty);
                    ["blue", "amber", "pink"].forEach((c, i) => {
                        const td = document.createElement("td");
                        if (c === "blue" || b[0].endsWith("crease") || ["random", "stop"].includes(b)) {
                            if (Array.isArray(b)) {
                                b.forEach(ctl => {
                                    td.appendChild(motorButton(ctl, i, c));
                                });
                            } else {
                                td.appendChild(motorButton(b, i, c));
                            }
                        }
                        row.appendChild(td);
                    });

                    tbody.appendChild(row);
                });
            })();

            function updateCamera(i) {
                document.getElementById("img" + i).setAttribute("src", urlBase + ips[i] + ":9955?" + new Date().getTime());
            }

            setInterval(() => { updateCamera(0); }, 1000);

            function setStats(s, i) {
                document.getElementById("indicator-speedR" + i).innerHTML = new Number(s.speedR).toFixed(2);
                document.getElementById("indicator-speedL" + i).innerHTML = new Number(s.speedL).toFixed(2);
                document.getElementById("indicator-direction" + i).innerHTML = s.isForward ? "Forward" : "Reverse";
                if (i === 0) {
                    document.getElementById("button-toggleForwardReverse0").innerHTML = s.isForward ? "Reverse" : "Forward";
                }
            }

            function getStats() {
                ips.forEach((ip, i) => {
                    const get = new XMLHttpRequest();
                    get.responseType = "json";
                    get.open("GET", urlBase + ip + ":9977/", true);
                    get.onload  = function() {
                        setStats(get.response, i)
                    };
                    get.send();
                });
            }

            function postMotorCommand(cmd, i) {
                const post = new XMLHttpRequest();
                post.responseType = "json";
                post.open("POST", urlBase + ips[i] + ":9977/" + cmd, true);
                post.send();
            }

            function postSoundCommand(cmd) {
                ips.forEach((ip, i) => {
                    const post = new XMLHttpRequest();
                    post.responseType = "json";
                    post.open("POST", urlBase + ip + ":9966/" + cmd, true);
                    post.setRequestHeader("Content-Type", "application/json; charset=utf-8");
                    post.onload  = function() {
                        const vol = post.response.volume
                        document.getElementById("indicator-volume" + i).innerHTML = new Number(vol).toFixed(0);
                    };
                    post.send();
                });
            }

            ["random", "ahead", "left", "right", "stop", "increase", "decrease", "toggleForwardReverse"].map(c => {
                [0, 1, 2].forEach(i => {
                    const b = document.getElementById("button-" + c + i);
                    if (b) {
                        b.setAttribute("onclick", "postMotorCommand(\"" + c + "\", " + i + ");");
                    }
                });
            });

            ["volMin", "volDown", "volUp", "volMax"].map(c => {
                document.getElementById("button-" + c).setAttribute("onclick", "postSoundCommand(\"" + c + "\");");
            });

            function postShutdown() {
                const result = window.confirm("Shutdown - are you sure?");
                if (result) {
                    postSoundCommand("shutdown")
                }
            }
            document.getElementById("button-shutdown").setAttribute("onclick", "postShutdown();");

            const play = (function() {
                let state = "stopped";

                return {
                    changeState: function() {
                        const button = document.getElementById("button-play");
                        if (state === "paused") {
                            postSoundCommand("resume");
                            state = "playing";
                            button.innerHTML = "pause"
                            return;
                        }
                        if (state === "playing") {
                            postSoundCommand("pause");
                            state = "paused";
                            button.innerHTML = "resume"
                            return;
                        }
                        if (state === "stopped") {
                            postSoundCommand("play");
                            state = "playing";
                            button.innerHTML = "pause"
                        }
                    }
                };
            })();
            document.getElementById("button-play").setAttribute("onclick", "play.changeState();");

            function getVolume() {
                ips.forEach((ip, i) => {
                    const req = new XMLHttpRequest();
                    req.responseType = "json";
                    req.open("GET", urlBase + ip + ":9966/", true);
                    req.onload  = function() {
                        document.getElementById("indicator-volume" + i).innerHTML = new Number(req.response.volume).toFixed(0);
                        document.getElementById("indicator-state" + i).innerHTML = req.response.state;
                    };
                    req.send();
                });
            }
            getVolume();
            setInterval(getStats, 1001);
        </script>
    </body>
</html>
